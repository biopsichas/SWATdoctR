<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

---
title: "Zglowiaczka catchment (PL)"
author: "name surname"
affiliation: "your affiliation"
email: "your@email"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

This is a document template for providing report for setup verification workflow and its output in html format. 

## Running model

Before starting working with `SWATdoctR` functions it is necessary to set paths to model to be verified and a folder, which could be used to save large files generated by the `run_swat_verification()` function.  

```{r}
library(SWATdoctR)
##Set SWAT+ model path txtitout folder
model_path <- "path_to_txtinout"
##This path to save run_swat_verification function results
result_path <- "path_to_run_swat_verification_results"
model_name <- "model_a"

model_path <- "../Test_models/Zglowiaczka"
result_path <- "./test_data/"
model_name <- "Zglowiaczka"
rpath <- c()
for(ns in c(0:2)){rpath <- c(rpath, paste0(result_path, model_name, "_ns", ns, ".rds"))}
```

Running `run_swat_verification()` function is important for `SWATdoctR` package as outputs of this function is used by other package functions. Code below runs function with different plant stress options activated and saves results in `.rds` files for the later examination. This is important as this step could be very time consuming (requires 3 model runs). Saving function results allows examining results without rerunning `run_swat_verification()` function. However, if the model was changed (by adjusting parameters, correcting/new input data, etc) function should be rerun.

```{r, eval = FALSE}
##Fixing management operations (changing hvkl to harv + kill). If there is not such issues nothing will be changed.
add_kill_op(model_path)
##Running loop to get and save run_swat_verification function output for different plant stress options
for(ns in c(0:2)){
  saveRDS(run_swat_verification(project_path = model_path, outputs = c('wb', 'mgt', 'plt'), 
                                nostress = ns, keep_folder = TRUE), file = rpath[[ns+1]])}
```

Before starting model verification `run_swat_verification()`results should be loaded in the memory. The first two steps require function results without plant stresses activate (`nostress = 1`).

```{r}
sim_nostress <- readRDS(file = rpath[2])
```

```{r setup, include=FALSE}
##Here adding some functions and libraries to be used in template
library(DT)
##Function to deliver table 
create_dt <- function(table, pL=10){
  DT::datatable(table,
                extensions = 'Buttons',
                fillContainer = FALSE, 
                options = list(pageLength = pL, 
                  initComplete = JS(
                  "function(settings, json) {",
                  "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff', 'font-size': '80%'});",
                  "}"),
                  dom = 'Blfrtip',
                  buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                  lengthMenu = list(c(pL,25,50,-1),
                                    c(pL,25,50,"All")),
                  columnDefs = list(list(className = 'dt-center', targets="_all"))),
                height = "100%")
}
```

## Step 1: Climate & Water flows

### Analysis of simulated annual climate variables

The first step in verification workflow is to check climatic variables simulated by model. Multiple mistakes (as wrong units, mistake in inputs, etc) could cause a lot of problems in model. `plot_climate_annual()` function provides quick overview of climatic variables. 

```{r fig.width = 20, fig.height = 7}
plot_climate_annual(sim_nostress)
```

### Seasonal dynamics of the precipitation

`plot_monthly_snow()` function generates overview for precipitation partition into snow fall and rain as well as provides summary of snowmelt monthly averages for simulation period.

```{r fig.width = 12, fig.height = 10}
plot_monthly_snow(sim_nostress)
```

### Water partition

`plot_water_partition` function generates interactive figure plotting water pathway distribution after precipitation reached the ground.  

```{r, out.width="80%"}
plot_water_partition(sim_nostress)
```

### HRU variable distribution

For detail examination of HRU variables `plot_hru_var_aa()` function could be applied with possibility to filter HRU by landuse (`lum` parameter in function), management (`mgt`) and soil (`soil`) labels. 

```{r, out.width="80%"}
plot_hru_var_aa(sim_nostress)
```

## Step 2: Management

### Examining issues with management

Management operation inputs in a SWAT+ model setup can be very complex and comprehensive (i.e. could include multiple years, plants, operations, even set to each field separately, etc). Scheduled operations point to several other input files which define the parameters of operations or inputs such as fertilizer or tillage types. Hence, the development of management schedules is highly error prone. Mistakes in management inputs usually do not stop a simulation or produce warnings in the model diagnostics, but lead to skipping certain operations in a simulation run.

Function `report_mgt()` can be applied to identify discrepancies between management operations in model input files and what operations are actually triggered in the model. If `write_report` parameter is set to TRUE, function also provides a report in *"schedule_report.txt"* text file. 

```{r}
mgt_report <- report_mgt(sim_nostress)
mgt_report
print(paste("Issues were identified in", length(mgt_report$schedule), "schedules."))
```

### Case to examine in tables

The function `report_mgt()` generates list of possible issues for management types. To examine them is detail on case-by-case basis following lines could be applied to receive case specific information and table about which management operations were triggered in model.

```{r}
##Select an example case to examine
sel_nb <- 2
if(length(mgt_report$schedule)>=sel_nb){
  sel_mgt <- mgt_report[[sel_nb,"schedule"]]
  ##Print selected case into interactive table
  print(paste("Table of issues for selected management", sel_mgt))
  create_dt(mgt_report$schedule_report[[sel_nb]])
} else {
   id <- get_hru_id_by_attribute(sim_nostress)
}
```

```{r}
if(length(mgt_report$schedule)>=sel_nb){
  ##Get HRU ids
  id <- get_hru_id_by_attribute(sim_nostress, mgt = sel_mgt)
  ##Print triggered management table
  print(paste("HRU", id$id[1], "trigerred management table"))
  create_dt(print_triggered_mgt(sim_nostress, id$id[1]))
}
```

### Case to examine in figures

Selected case can be examined in figures plotting selected HRU variables. Following variables are available for plotting.

- *lai m^2^/m^2^ |average leaf area index during timestep*
- *bioms kg/ha |average total plant biomass during timestep*
- *yield kg/ha |harvested biomass yield (dry weight) during timestep*
- *residue kg/ha |average surface residue cover during timestep*
- *sol_tmp deg C |average temperature of soil layer 2 during timestep*
- *strsw days |limiting water (drought) stress*
- *strsa days |excess water (aeration) stress*
- *strstmp days |temperature stress*
- *strsn days |nitrogen stress*
- *strsp days |phosphorus stress*
- *nplnt kg N/ha |plant uptake of nitrogen*
- *percn kg N/ha |nitrate NO3-N leached from bottom of soil profile*
- *pplnt kg P/ha |plant uptake of phosphorus*
- *tmx deg C |average maximum temperature during timestep*
- *tmn deg C |average minimum temperature during timestep*
- *tmpav deg C |average of average daily air temperature during timestep*
- *solrad MJ/m^2 |average solar radiation during timestep*
- *wndspd m/s |average windspeed during timestep*
- *rhum none |average relative humidity during timestep*
- *phubase0 deg c |base zero potential heat units*

Function `plot_hru_pw()` can be used for this. It provides static and interactive options as well as aggregation by time interval (week, month, year, etc) and type of aggregation operation (mean, sum, max, etc).

```{r fig.width = 10, fig.height = 6}
plot_hru_pw(sim_nostress, id$id[1], "lai")
plot_hru_pw(sim_nostress, id$id[1], c("lai", "bioms", "yield", "residue"), period = "month", fn_summarize = "max", interactive = TRUE)
```

## Step 3: Plant growth without stess factors

The verification of plant growth is a two-tiered approach. In a first step plant growth is simulated
and analyzed without simulating any limiting stress factors. Such analysis illustrates the potential biomass or yields, which plants can gain given the climatic and soil conditions of the simulated catchment. Moreover, it allows us to verify the duration of the scheduled growing period or if the selected crop parametrizations meet the climatic conditions.

`plot_variable_at_harvkill()` function can be applied to extract relevant variables at the time of harvesting a crop (available options are 'phu', 'yield', 'bioms'). 

### Check the stress factors

It is all so important to check, if plant stress factors are actually switched off. If correct a figure should be plotting zeros.

```{r fig.width = 10, fig.height = 6}
plot_variable_at_harvkill(sim_nostress, variable = 'stress')
```

### Plot variables during harvest

Plotting PHUs (plant heat units) and yield could help to verify plant growth. 

```{r fig.width = 10, fig.height = 6}
plot_variable_at_harvkill(sim_nostress, variable = 'phu')
plot_variable_at_harvkill(sim_nostress, variable = 'yield')
```

### Step 4: Plant growth with stress active

The next step includes activating potential sources for plant growth stresses, such as nutrient stress due to limited fertilizer inputs, or water stress due to limited water availability. An analysis of plant growth with active stresses can show issues in quantities of scheduled operations, such as the amounts of fertilizer inputs, or the problems with definition of irrigation schedules, or decision table rules. 
Setting `nostress = 0` while running `run_swat_verification()` function will activate all stresses, however turning off the nutrient plant stress only can as well be a useful option for analyses (`nostress = 2`).  This is particularly useful for eliminating the fertilization impact on the plant growth and focusing only on the weather/climate and structural setting of the plant. Particularly, the aeration, temperature, and water stress, alongside yields are relevant outputs to be analyzed. A simulation with inactive nutrient stress will provide a good approximation of possible yields with an optimal fertilization and ideal plant nutrient supply. All other stresses will indicate the need of irrigation, drainage or plant-specific parameter adjustments for a plant to grow. 

```{r, include=FALSE}
sim_except_nutrient <- readRDS(file = rpath[3])
sim_stress_all <- readRDS(file = rpath[1])
sim_list <- list(no_stress = sim_nostress["mgt_out"],
                 except_nutrient = sim_except_nutrient["mgt_out"],
                 stress_all = sim_stress_all["mgt_out"])
rm(sim_nostress)
```

### Examine stress factors 

It is possible to plot each case side-by-side for examination with same functions applied. For instance `plot_variable_at_harvkill()` could be run to check how much stress factors affect in each case. 

```{r fig.width = 15, fig.height = 10}
plot_variable_at_harvkill(sim_stress_all, variable = 'stress')
```

### Check the difference for selected HRU

Additionally, we can look how plant growth is different in the same HRUs. 

```{r fig.width = 10, fig.height = 6}
plot_hru_pw(sim_except_nutrient,  id$id[1], var = c('lai', 'bioms'))
plot_hru_pw(sim_stress_all,  id$id[1], var = c('lai', 'bioms'))
```

### Assess difference for yields

Could be useful to examine how harvest is affected by stresses factors. 

```{r fig.width = 10, fig.height = 6}
plot_variable_at_harvkill(sim_list, variable = 'yield')
```

## Simulated point sources and tile drains

The point source time series inputs define the water, sediment, and nutrient loads which are emitted by a point source into a spatial object. The common issues are wrong units of the defined fluxes or wrong time intervals for a certain accumulated flux. SWAT+ projects can potentially have a large number of unique point sources, which may be another reason for errors. Thus, it is good practice to verify the simulated influxes from point sources into the respective spatial objects.

The verification of tile flow can focus on whether tile flow occurs or not. Also could be important to examine the rate of tile flow.

Point source data could be examined using `plot_ps()` function. If `conc = FALSE`, yearly loads for different point sources will be provided in a figure. If `conc = TRUE`, concentration figure will be generated.


```{r fig.width = 10, fig.height = 7}
plot_ps(sim_stress_all)
```

```{r fig.width = 10, fig.height = 7}
plot_ps(sim_stress_all, TRUE)
```

For examining tile drain flow two functions are available in the `SWATdoctR` package. `print_avannual_qtile()` function extracts tile flow for HRUs with installed tile drain systems.

```{r}
print_avannual_qtile(sim_stress_all)
```

`plot_qtile()` provides histogram and distribution curve in a figure for tile drain flows (in mm/year units).  

```{r fig.width = 10, fig.height = 7}
plot_qtile(sim_stress_all)
```

```{r, include = FALSE}
rm(sim_stress_nutrient, sim_stress_all)
```
